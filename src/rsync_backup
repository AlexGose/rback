#!/usr/bin/env bash
#
# Rsync-based script for backups

error() {
  echo "ERROR: ${BASH_SOURCE[0]}: $1" >&2
  exit 1
}

usage() {
  local usage_string
  usage_string="Usage: rsync_backup OPTIONS
  OPTIONS
  -h                     Display this help message"
  echo "${usage_string}"
}

# Rotate snapshot folders by a given interval of elapsed time
#
# Usage: rotate_snapshots <backup dir> <time unit> <interval> <limit>
#
# Inputs: <backup dir> - path to the directory containing all snapshot folders
#         <time unit> - unit of time ("minute","hour","day",etc.)
#         <interval> - integer interval of elapsed time, time between snapshots
#         <limit> - integer limit of elapsed time, time limit of snapshots
#
# In the backup directory, a snapshot folder for <limit> + <interval> elapsed
# time will be created temporarily if it does not already exist; otherwise,
# an error will occur.  Other folders and files in the backup directory will
# potentially be modified or deleted.
rotate_snapshots() {
  local backup_dir
  backup_dir=$1
  local time_unit
  time_unit=$2
  local interval
  interval=$3
  local limit
  limit=$4
  if [[ -d "${backup_dir}/${time_unit}.$(( limit + interval ))" ]]; then
    local error_prefix
    error_prefix="${FUNCNAME[0]}: ${LINENO[0]}: ${backup_dir}/"
    error "${error_prefix}${time_unit}.$(( limit + interval )) already exists"
  fi

  for (( n = limit; n >= interval; n -= interval )); do
    if [[ -d "${backup_dir}/${time_unit}.${n}" ]]; then
      mv -- "${backup_dir}/${time_unit}.${n}" \
          "${backup_dir}/${time_unit}.$(( n + interval ))"
    fi
  done
  mv -- "${backup_dir}/${time_unit}.$(( limit + interval ))" \
      "${backup_dir}/${time_unit}.${interval}"
}

main() {
  if (( $# == 0 )); then
    usage
    error "${FUNCNAME[0]}: ${LINENO[0]}: at least one option required"
  fi

  while getopts :h opt; do
    case "${opt}" in
      h) usage; exit 0 ;;
      *) : ;;
    esac
  done
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  main "$@"
fi
